# M23 — Approval Flow Redesign

**Branch:** `feature/m23-approval`
**Status:** PLANNED
**Depends on:** M21 (versioning) + M22 (comments) — HARD DEPENDENCIES

## Overview
Rozszerzenie M12. 3 stany zamiast 2: rejected, accepted_with_comments, accepted. Claude dostaje strukturalny feedback. Integracja z versioning i comments.

## Approval Flow

```
Claude: mockup_await_approval(project_id, screen_id, timeout_seconds=300)
  ↓ user w edytorze:
  ├── [Accept]              → status="approved" → Claude: { status: "accepted" }
  ├── [Accept with comments]→ user dodaje komentarze → status="draft"
  │                            Claude: { status: "accepted_with_comments", comments: [...] }
  │                            Claude: create_screen_version → iteruje per komentarz → pętla
  └── [Reject]              → status="rejected"
                               Claude: { status: "rejected", reason: "..." }
                               Claude: create_screen_version → od nowa → pętla
```

## Tasks

| # | Task | Pliki | Status |
|---|------|-------|--------|
| T1 | Approval state redesign (3 stany + comments passing) | `src/preview/server.js` (approval route) | PLANNED |
| T2 | MCP tool redesign `mockup_await_approval` | `src/mcp/tools/approval-tools.js` (NEW lub refactor) | PLANNED |
| T3 | Versioning integration (auto set status) | `src/mcp/tools/approval-tools.js` | PLANNED |
| T4 | Editor UI: 3 przyciski (Accept / Accept+comments / Reject) | `src/preview/editor/editor.js`, `approval.js` (NEW) | PLANNED |
| T5 | Comment migration przy nowej wersji | `src/storage/project-store.js` | PLANNED |
| T6 | MCP resource update `mockup://approval` | `src/mcp/resources.js` | PLANNED |
| T7 | Testy | `tests/mcp/approval-tools.test.js`, `tests/preview/approval-api.test.js` | PLANNED |

## Key Changes vs M12
- `mockup_await_approval` timeout default: 300s (było 120s)
- Response: `{ status: "accepted"|"accepted_with_comments"|"rejected", comments: [...], reason?: "..." }`
- Backward compat: `{ status: "accepted" }` = poprzednie `{ approved: true }`
