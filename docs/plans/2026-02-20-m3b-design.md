# M3b Design — SSE Transport, Docker Hub, Animated Transitions

**TL;DR:** Streamable HTTP transport on port 3200 (new MCP standard), Docker Hub publish via GitHub Actions CI/CD (`mggs/mockupmcp`), CSS-only animated transitions in preview (push/fade/slide-up/none).

---

## Feature 1: Streamable HTTP Transport

### Approach
Stateful HTTP on separate Express app (port 3200), isolated from preview server (3100).

### Architecture
```
src/index.js
  ├─ if (stdio|both) → startMcpServer()       [existing, stdin/stdout]
  ├─ if (http|both)  → startHttpTransport()    [new, Express :3200]
  └─ startPreviewServer()                      [existing, Express :3100]

src/mcp/http-transport.js
  └─ Express app (POST/GET/DELETE /mcp)
      └─ Map<sessionId, { transport, server }>
          └─ each: McpServer + registerAllTools(server, store) + StreamableHTTPServerTransport
```

### Key Decisions
- New file: `src/mcp/http-transport.js` — Express + StreamableHTTPServerTransport + session management
- Each HTTP session = separate McpServer (SDK requirement: 1 transport per server.connect())
- All sessions share the same ProjectStore singleton
- Session limits: max 10, 30min idle timeout with cleanup
- ENV: `MCP_TRANSPORT=stdio|http|both` (default: both), `MCP_PORT=3200`
- No OAuth (Docker + local dev context)

### Risks
- Race condition on ProjectStore (JSON files without locks) — pre-existing, not new
- stdio does not block event loop (Node streams are async)

---

## Feature 2: Docker Hub Publish

### Approach
GitHub Actions + official Docker actions (`docker/build-push-action`).

### Pipeline
- Trigger: push tag `v*` (e.g. `v0.2.0`) + manual `workflow_dispatch`
- Build: `docker/setup-buildx-action` + `docker/build-push-action`
- Multi-arch: `linux/amd64,linux/arm64`
- Layer cache: `type=gha`
- Image: `mggs/mockupmcp:latest` + `mggs/mockupmcp:v0.2.0`
- Secrets: `DOCKERHUB_USERNAME`, `DOCKERHUB_TOKEN`

### Additional
- `.dockerignore` (node_modules, .git, tests, PM/)
- `docker-compose.yml` update with Docker Hub image reference
- README badge

---

## Feature 3: Animated Transitions in Preview

### Approach
SPA fetch (no page reload) + CSS-only animations.

### Flow
```
User clicks [data-link-to="scr_xxx" data-transition="push"]
  → JS: fetch('/api/screen-fragment/proj_yyy/scr_xxx')
  → JS: extract .screen from response
  → CSS: animate current .screen out
  → CSS: animate new .screen in
  → JS: replace .screen, pushState, update lastMod for polling
```

### Transition Types
| Type | Animation | Use case |
|------|-----------|----------|
| `push` | Old slides left, new slides in from right | iOS-style navigation |
| `fade` | Crossfade (opacity) | General purpose |
| `slide-up` | New slides up from bottom | Modal-style |
| `none` | Instant swap | No animation |

### Key Decisions
- New endpoint: `GET /api/screen-fragment/:projectId/:screenId` — returns only `.screen` div HTML
- LINK_SCRIPT in preview modified: fetch+swap instead of redirect
- Duration: 300ms
- `history.pushState()` + `popstate` handler for Back/Forward
- Back button: reverse animation (push → slide right)
- Polling auto-reload continues working (lastMod updated after swap)
- `data-transition` attribute already exists on link elements (html-builder.js)

---

## Files Changed/Created

| File | Action | Purpose |
|------|--------|---------|
| `src/config.js` | EDIT | `mcpPort`, `mcpTransport` env vars |
| `src/index.js` | EDIT | Conditional transport startup |
| `src/mcp/server.js` | EDIT | Extract `createMcpServer` factory |
| `src/mcp/http-transport.js` | NEW | Express + StreamableHTTP + sessions |
| `src/preview/server.js` | EDIT | SPA transitions, fragment endpoint |
| `Dockerfile` | EDIT | EXPOSE 3200, MCP_PORT env |
| `docker-compose.yml` | EDIT | Port 3200, Docker Hub image |
| `.github/workflows/docker-publish.yml` | NEW | CI/CD pipeline |
| `.dockerignore` | NEW | Exclude node_modules, .git, tests |

---

## Sprint Breakdown

### Sprint 1: HTTP Transport (5 tasks)
1. `MCP_TRANSPORT` + `MCP_PORT` in config — S
2. `http-transport.js` — Express + Streamable HTTP + session mgmt — L
3. `index.js` — conditional startup stdio/http/both — M
4. Dockerfile/docker-compose — EXPOSE 3200, env vars — S
5. Tests HTTP transport (unit + integration) — M

### Sprint 2: Docker Hub + Transitions (5 tasks)
6. GitHub Actions CI/CD (amd64 + arm64) — M
7. `.dockerignore` + Dockerfile optimization — S
8. Preview transitions: CSS animations + SPA fetch — L
9. Preview: `/api/screen-fragment` endpoint — S
10. Tests transitions + preview regression — M

### Sprint 3: Integration + Docs (3 tasks)
11. E2E test: stdio + HTTP simultaneous (both mode) — M
12. README badge + docs update + docker-compose example — S
13. PM update: milestones.md, tasks, CLAUDE.md — S
