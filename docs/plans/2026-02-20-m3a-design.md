# M3a Design — Code Export, Navigation, Flow, Grouping

**Date:** 2026-02-20
**Status:** Approved
**Scope:** 6 features, 6 new MCP tools (17→23 total), ~10 new files

---

## TL;DR

M3a adds code generation (HTML/React/Flutter/SwiftUI), screen-to-screen navigation with clickable preview links, Mermaid flow diagram export, element grouping, and opacity/layers support.

---

## 1. Code Export (`mockup_to_code`)

### Architecture

New `src/codegen/` directory with plugin pattern (same as components — pure functions).

```
src/codegen/
  index.js          # Registry: getGenerator(framework) → { generate(screen) }
  html.js           # HTML5 + inline CSS
  react.js          # React functional components + CSS modules
  flutter.js        # Flutter Widget tree (Dart)
  swiftui.js        # SwiftUI View structs
```

### Generator pattern

```js
// Each generator exports:
export function generate(screen) → string   // full component code
export function mapComponent(element) → string  // single element mapping
```

### Mapping logic

- Iterates `screen.elements`, maps each component type to framework equivalent
- Positioning: absolute (faithful to mockup) in v1
- Future improvement: Flex/Stack-based layout generation

### MCP tool

```
mockup_to_code(screen_id, framework: "html"|"react"|"flutter"|"swiftui")
→ { code: string, framework: string, component_count: number }
```

---

## 2. Navigation (Links)

### Data model

Link lives on element, in `properties.link_to`:

```js
element.properties.link_to = {
  screen_id: "scr_abc",    // target screen
  transition: "push"        // push | fade | slide | none
}
```

No separate table/array — link is element property. Simple, zero redundancy.

### MCP tools

```
mockup_add_link(element_id, target_screen_id, transition?: "push")
  → sets element.properties.link_to

mockup_remove_link(element_id)
  → removes element.properties.link_to
```

### Preview — clickable links

- `html-builder.js` adds `data-link-to="/preview/{projectId}/{screenId}"` on elements with `link_to`
- `cursor: pointer` + hover highlight (border)
- JavaScript in preview template: `click → window.location = data-link-to`
- Back button in preview UI for backward navigation

### Validation

- `mockup_add_link` checks that `target_screen_id` exists in same project
- When deleting a screen — links to it become orphaned (warning in `mockup_list_elements`)

---

## 3. Flow Export (`mockup_export_flow`)

### Logic

Scans all screens in project, collects elements with `link_to`, generates navigation graph.

### New file: `src/codegen/flow.js`

```js
export function generateMermaid(project) → string
// graph LR
//   scr_001[Login Screen] -->|button: Sign In| scr_002[Dashboard]
//   scr_002[Dashboard] -->|tab: Settings| scr_003[Settings]
```

### MCP tool

```
mockup_export_flow(project_id, format: "mermaid"|"svg"|"png")
  → mermaid: { content: string, format: "mermaid" }
  → svg/png: { content: base64, format: "svg"|"png" }
```

### Mermaid rendering (SVG/PNG)

- Puppeteer loads page with `<script src="mermaid.min.js">` + diagram text
- Screenshot → PNG, or innerHTML of SVG node → SVG
- Mermaid.js bundled in `src/codegen/vendor/mermaid.min.js` (~200KB)

---

## 4. Grouping

### Data model

New field `screen.groups[]`:

```js
screen.groups = [
  { id: "grp_abc", name: "Header Section", element_ids: ["el_001", "el_002", "el_003"] }
]
```

Elements don't know about groups — group is a list of references. Flat structure (no nested groups in v1).

### MCP tools

```
mockup_group_elements(screen_id, element_ids[], group_name?)
  → creates grp_ record, returns group_id

mockup_ungroup_elements(screen_id, group_id)
  → removes group, elements stay in place
```

### Group operations

`mockup_move_element` extended with `group_id` parameter — moves all group elements by same delta. No new tool needed.

---

## 5. Layers / Opacity

### Data model extension

```js
element.properties.opacity = 0.5  // 0.0 - 1.0, default 1.0
```

- `html-builder.js` adds `opacity: ${props.opacity}` to wrapper inline style
- Handled by existing `mockup_update_element` — zero new tools
- `z_index` already works (M1) — sufficient for layer ordering

---

## 6. File Changes Summary

| File | Change |
|------|--------|
| `src/codegen/index.js` | NEW — codegen registry |
| `src/codegen/html.js` | NEW — HTML generator |
| `src/codegen/react.js` | NEW — React generator |
| `src/codegen/flutter.js` | NEW — Flutter generator |
| `src/codegen/swiftui.js` | NEW — SwiftUI generator |
| `src/codegen/flow.js` | NEW — Mermaid flow generator |
| `src/codegen/vendor/mermaid.min.js` | NEW — Mermaid.js bundle |
| `src/mcp/tools/export-tools.js` | MODIFY — add mockup_to_code, mockup_export_flow |
| `src/mcp/tools/element-tools.js` | MODIFY — add mockup_add_link, mockup_remove_link |
| `src/mcp/tools/screen-tools.js` | MODIFY — add mockup_group_elements, mockup_ungroup_elements |
| `src/mcp/tools/index.js` | MODIFY — register 6 new tools |
| `src/storage/project-store.js` | MODIFY — groups CRUD, link validation, group move |
| `src/renderer/html-builder.js` | MODIFY — link data attributes, opacity CSS |
| `src/preview/templates/preview-page.html` | MODIFY — click handler for links, back button |

---

## 7. M3b (deferred)

- SSE transport (replace polling with EventSource)
- Animated transitions in preview (CSS)
- Docker Hub / GHCR publish (CI/CD)
